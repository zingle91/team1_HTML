/*! SmartEditor3 - v1.0.0 - 2018-05-10
* Copyright (c) 2018 NAVER Corp; Licensed  */

se.defineComponent("se.HistoryBasicComparator",{construct:function(){},isContain:function(a,b){var c=false,d="";var e=function(a){delete a.focusEvent;delete a.represent};var f,g,h=false,i;if((a.TYPE==="card"||a.TYPE==="component")&&b.TYPE==="canvas"){f=JSON.stringify(b.DATA);i=$.extend(true,{},b.DATA);g=$.extend(true,{},a.DATA);h=true;d="pop"}else if(a.TYPE==="canvas"&&(b.TYPE==="component"||b.TYPE==="card")){f=JSON.stringify(a.DATA);i=$.extend(true,{},a.DATA);g=$.extend(true,{},b.DATA);h=true;d="skip"}if(h){if(f.indexOf(g.compId)>-1){var j=$SE_CONFIG.ENV_SETTING.IS_CARD_DOC?i.cards:i.components;var k;e(g);for(var l=0;l<j.length;l++){k=$.extend(true,{},j[l]);e(k);if(g.compId===k.compId&&_.isEqual(k,g)){c=true;break}}}}return{bExist:c,sSkipType:d}}});se.defineComponent("se.HistoryCardComparator",{construct:function(){},isContain:function(a,b){var c=null;var d=null;var e=false;var f=null;if(a.TYPE==="card"&&b.TYPE==="canvas"){d=a.DATA.activated;c=_.findWhere(b.DATA.cards,{id:d.id});f="pop"}else if(a.TYPE==="canvas"&&b.TYPE==="card"){c=b.DATA.activated;d=_.findWhere(a.DATA.cards,{id:c.id});f="skip"}if(_.isEqual(d,c)){e=true}return{bExist:e,sSkipType:f}}});se.defineComponent("se.HistoryCompareExecutor",{construct:function(){this._htComparator={card:new se.HistoryCardComparator,basic:new se.HistoryBasicComparator}},isContain:function(a,b){var c=$SE_CONFIG.ENV_SETTING.IS_CARD_DOC?"card":"basic";return this._htComparator[c].isContain(a,b)}});se.defineComponent("se.HistoryManager",{construct:function(){this._initVar()},_initVar:function(){this._aHistoryStack=null;this._nMaxSizeHistory=50;this._IDLE_AUTOSAVE_TIME=4e3;this._nCurrentPosition=0;this._MAX_SAVE_SKIP=$SE_CONFIG.SERVICE_CONFIG.MAX_SAVE_SKIP;this._nAutoSaveTimer=-1;this._nAutoSaveSkip=this._MAX_SAVE_SKIP},pushHistory:function(a){var b=JSON.stringify(a),c=false;if(!this._aHistoryStack){this._aHistoryStack=[]}else{var d=this._aHistoryStack.length-1;var e=0;if(d!=this._nCurrentPosition){e=this._nCurrentPosition>0?this._nCurrentPosition:0;this._aHistoryStack=this._aHistoryStack.slice(0,e+1)}}if(this._aHistoryStack.length>0){var f=this._isExistHistory(JSON.parse(this._aHistoryStack[this._aHistoryStack.length-1]),a);if(f.bExist){if(f.sSkipType==="pop"){this._aHistoryStack.pop();if(this._nCurrentPosition>0){this._nCurrentPosition--}}else if(f.sSkipType==="skip"){c=true}}}if(!c){if(this._aHistoryStack.length>0&&this._nCurrentPosition<this._nMaxSizeHistory-1){this._nCurrentPosition++}if(this._aHistoryStack.length<this._nMaxSizeHistory){this._aHistoryStack.push(b)}else{this._aHistoryStack.push(b);this._aHistoryStack.shift()}}if(this._nCurrentPosition>0&&!a.DATA.focusEvent){if(this._nAutoSaveTimer>-1){clearTimeout(this._nAutoSaveTimer);this._nAutoSaveSkip--;if(this._nAutoSaveSkip===0){this._nAutoSaveSkip=this._MAX_SAVE_SKIP;this.trigger("onAutoSave");return false}}this._nAutoSaveTimer=setTimeout(function(){this.trigger("onAutoSave");this._nAutoSaveTimer=-1;this._nAutoSaveSkip=this._MAX_SAVE_SKIP}.bind(this),this._IDLE_AUTOSAVE_TIME)}},_isExistHistory:function(a,b){this._oCompareExecutor=new se.HistoryCompareExecutor;if(a.TYPE==b.TYPE){return this._checkCompareData(a,b)}else{return this._checkContainData(a,b)}},_checkContainData:function(a,b){return this._oCompareExecutor.isContain(a,b)},_checkCompareData:function(a,b){var c=false,d;var e=function(a){delete a.focusEvent;delete a.represent};var f=JSON.parse(JSON.stringify(b.DATA));var g=JSON.parse(JSON.stringify(a.DATA));var h=function(a){var b=[];a=a||[];a.forEach(function(a){b.push(a["@ctype"])});return b.join("_")};var i,j;e(f);e(g);d="pop";if(a.TYPE==="canvas"){i=$SE_CONFIG.ENV_SETTING.IS_CARD_DOC?f.cards:f.components;j=$SE_CONFIG.ENV_SETTING.IS_CARD_DOC?g.cards:g.components;if(h(i)===h(j)){c=true}}else{c=true}if(c){c=_.isEqual(f,g)}return{bExist:c,sSkipType:d}},getUndoData:function(){this._nCurrentPosition--;var a=JSON.parse(this._aHistoryStack[this._nCurrentPosition]);return a},getRedoData:function(){this._nCurrentPosition++;var a=JSON.parse(this._aHistoryStack[this._nCurrentPosition]);return a},getUndoSize:function(){return this._nCurrentPosition},getRedoSize:function(){var a=0;if(this._aHistoryStack&&this._aHistoryStack.length){a=this._aHistoryStack.length}return a-1-this._nCurrentPosition},reset:function(){this._aHistoryStack=null;this._nCurrentPosition=0},deleteLastHistory:function(){if(this._aHistoryStack&&this._aHistoryStack.length>0){this._aHistoryStack.pop();this._nCurrentPosition--}},destroy:function(){}});se.defineController("se.HistoryController",{construct:function(a){this._initVar(a);this._createModule();this._bindModuleEvent();this._bindGatewayEvent()},_initVar:function(a){this._oManager=null;this._htHistoryCallback=a.htCallback},_createModule:function(){this._oManager=new se.HistoryManager},_bindModuleEvent:function(){this._oManager.on("onAutoSave",function(){if($SE_CONFIG.ENV_SETTING.AUTO_SAVE_USE&&!$SE_CONFIG.ENV_SETTING.IS_SPELLER_ON){this.oApp.exec("TOP_SAVE_TEMP_DOCUMENT",[false])}}.bind(this))},_bindGatewayEvent:function(){$SE_EVENT_HUB.on($SE_EVENT_HUB.MSG.CONTROL.DELETE_LAST_HISTORY,this.deleteLastHistory.bind(this));$SE_EVENT_HUB.on($SE_EVENT_HUB.MSG.CONTROL.PUSH_HISTORY,this.pushHistory.bind(this))},pushHistory:function(a){this._oManager.pushHistory(a);this._updateUndoRedoControl()},$ON_HISTORY_RESET:function(){this._oManager.reset()},$ON_HISTORY_PUSH_HISTORY:function(a){this.pushHistory(a)},$ON_HISTORY_EXEC:function(a){var b;var c=this._oManager.getUndoSize();var d=this._oManager.getRedoSize();if(a=="UNDO"){if(c>0){b=this._oManager.getUndoData();this._htHistoryCallback[b.TYPE].undo(b.DATA)}}else if(a=="REDO"){if(d>0){b=this._oManager.getRedoData();this._htHistoryCallback[b.TYPE].redo(b.DATA)}}this._updateUndoRedoControl()},_updateUndoRedoControl:function(){var a=this._oManager.getUndoSize();var b=this._oManager.getRedoSize();this.oApp.exec("TOP_UPDATE_UNDO_REDO",[a,b])},$ON_MSG_APP_READY:function(){},deleteLastHistory:function(){this._oManager.deleteLastHistory()}});
//# sourceMappingURL=blog_desktop_normal_editor_control_history.min.js.map